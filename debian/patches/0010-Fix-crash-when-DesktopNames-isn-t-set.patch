From e1724800ecf3c6a7035dfa7bcaa50b2a8f48688f Mon Sep 17 00:00:00 2001
From: David Faure <faure@kde.org>
Date: Fri, 2 May 2014 10:26:38 +0200
Subject: [PATCH 10/16] Fix crash when DesktopNames isn't set

BUG: 334159
FIXED-IN: 4.11.10
---
 kdm/backend/client.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

Index: kde-workspace/kdm/backend/client.c
===================================================================
--- kde-workspace.orig/kdm/backend/client.c	2014-05-07 20:23:40.079982880 +0200
+++ kde-workspace/kdm/backend/client.c	2014-05-07 20:23:40.075983044 +0200
@@ -1814,12 +1814,14 @@
                             !(sessargs = iniEntry(str, "Desktop Entry", "Exec", 0)))
                         sessargs = "";
                     buf = iniEntry(str, "Desktop Entry", "DesktopNames", 0);
-                    for (buf2 = buf; *buf2; ++buf2) {
-                        if (*buf2 == ';')
-                            *buf2 = ':';
+                    if (buf) {
+                        for (buf2 = buf; *buf2; ++buf2) {
+                            if (*buf2 == ';')
+                                *buf2 = ':';
+                        }
+                        userEnviron = setEnv(userEnviron, "XDG_CURRENT_DESKTOP", buf);
+                        free(buf);
                     }
-                    userEnviron = setEnv(userEnviron, "XDG_CURRENT_DESKTOP", buf);
-                    free(buf);
                     free(str);
                     free(fname);
                     goto gotit;
